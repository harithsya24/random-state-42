<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BloodBank AI Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
/* FULL CSS same as your previous one... */
body { font-family: 'Consolas', monospace; background:#1e1e1e; color:#d4d4d4; margin:0; padding:0; }
.header { background:#252526; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #3c3c3c; }
.header h1 { color:#e74c3c; font-size:18px; }
.btn { padding:6px 12px; border-radius:4px; border:1px solid #3c3c3c; background:#2d2d30; color:#ccc; cursor:pointer; font-size:12px; transition:0.2s; }
.btn:hover { border-color:#007acc; background:#3c3c3c; }
.btn-emergency { color:#e74c3c; border-color:#e74c3c; }
.btn-optimize { color:#007acc; border-color:#007acc; }
.main-container { display:flex; height:calc(100vh - 50px); }
.map-container { flex:1; border-right:1px solid #3c3c3c; display:flex; flex-direction:column; }
#map { flex:1; }
.right-panel { flex:0 0 400px; display:flex; flex-direction:column; }
.metrics-panel { flex:0 0 50%; background:#252526; border-bottom:1px solid #3c3c3c; padding:10px; overflow:auto; }
.metrics-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:15px; }
.metric-card { background:#1e1e1e; padding:10px; border:1px solid #3c3c3c; border-radius:4px; }
.metric-label { font-size:10px; color:#858585; }
.metric-value { font-size:24px; font-weight:700; color:#4ec9b0; }
.console-panel { flex:0 0 30%; background:#1e1e1e; display:flex; flex-direction:column; }
.console-content { flex:1; overflow-y:auto; padding:10px; font-size:12px; line-height:1.5; }
.log-entry { margin-bottom:2px; }
.log-emergency { color:#f48771; }
.log-success { color:#4ec9b0; }
</style>
</head>
<body>

<div class="header">
<h1>ü©∏ BloodBank AI Dashboard</h1>
<div>
<button class="btn btn-emergency" onclick="openEmergencyModal()">Emergency</button>
<button class="btn btn-optimize">Optimize</button>
</div>
</div>

<div class="main-container">
<div class="map-container">
<div id="map"></div>
</div>

<div class="right-panel">
<div class="metrics-panel">
<div class="metrics-grid">
<div class="metric-card">
<div class="metric-label">HOSPITALS</div>
<div class="metric-value" id="metric-hospitals">0</div>
</div>
<div class="metric-card">
<div class="metric-label">BLOOD BANKS</div>
<div class="metric-value" id="metric-banks">0</div>
</div>
<div class="metric-card">
<div class="metric-label">DONORS</div>
<div class="metric-value" id="metric-donors">0</div>
</div>
<div class="metric-card">
<div class="metric-label">TRANSFERS</div>
<div class="metric-value" id="metric-transfers">0</div>
</div>
</div>
</div>

<div class="console-panel">
<div class="console-content" id="console-logs"></div>
</div>
</div>

<!-- Emergency Modal -->
<div id="emergency-modal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
<div style="background:#252526;padding:20px;border-radius:6px;width:300px;">
<h2 style="color:#ccc;">üö® Report Emergency</h2>
<input type="text" id="emergency-id" placeholder="E001" style="width:100%;margin-bottom:8px;padding:6px;">
<input type="text" id="hospital-id" placeholder="h1" style="width:100%;margin-bottom:8px;padding:6px;">
<select id="blood-type" style="width:100%;margin-bottom:8px;padding:6px;">
<option>A+</option><option>A-</option><option>B+</option><option>B-</option>
<option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
</select>
<input type="number" id="units-required" placeholder="5" style="width:100%;margin-bottom:8px;padding:6px;">
<div style="display:flex;justify-content:flex-end;gap:8px;">
<button class="btn" onclick="closeEmergencyModal()">Cancel</button>
<button class="btn btn-emergency" onclick="submitEmergency()">Submit</button>
</div>
</div>
</div>

<script>
let map = L.map('map').setView([40.7128, -74.0060], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers = {}, transferLines = [];

function addConsoleLog(message, type='info') {
    const container = document.getElementById('console-logs');
    const entry = document.createElement('div');
    entry.className = 'log-entry log-' + type;
    const now = new Date();
    const timestamp = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    entry.textContent = `${timestamp} | ${message}`;
    container.appendChild(entry);
    container.scrollTop = container.scrollHeight;
}

async function loadMapData() {
    const res = await fetch('/api/map_data');
    const data = await res.json();

    Object.values(markers).forEach(m=>map.removeLayer(m));
    transferLines.forEach(l=>map.removeLayer(l));
    markers={}; transferLines=[];

    data.nodes.forEach(n=>{
        const iconHtml = n.kind==='hospital'?'üè•':'n.kind==='bloodbank'?'ü©∏':'üßë';
        const icon = L.divIcon({html:`<div style="font-size:24px;">${iconHtml}</div>`, className:'custom-icon', iconSize:[30,30]});
        markers[n.id] = L.marker([n.lat,n.lon],{icon}).addTo(map).bindPopup(n.label);
    });

    data.transfers.forEach(t=>{
        if(markers[t.from] && markers[t.to]){
            const line = L.polyline([markers[t.from].getLatLng(), markers[t.to].getLatLng()], {color:'#e74c3c',weight:3,opacity:0.7,dashArray:'10,10'}).addTo(map);
            transferLines.push(line);
        }
    });

    document.getElementById('metric-hospitals').textContent = data.nodes.filter(n=>n.kind==='hospital').length;
    document.getElementById('metric-banks').textContent = data.nodes.filter(n=>n.kind==='bloodbank').length;
    document.getElementById('metric-donors').textContent = data.nodes.filter(n=>n.kind==='donor').length;
    document.getElementById('metric-transfers').textContent = data.transfers.length;
}

function openEmergencyModal(){document.getElementById('emergency-modal').style.display='flex';}
function closeEmergencyModal(){document.getElementById('emergency-modal').style.display='none';}

async function submitEmergency(){
    const emergency_id = document.getElementById('emergency-id').value;
    const hospital_id = document.getElementById('hospital-id').value;
    const blood_type = document.getElementById('blood-type').value;
    const units_required = parseInt(document.getElementById('units-required').value);

    closeEmergencyModal();
    addConsoleLog(`üö® Emergency submitted: ${emergency_id} at ${hospital_id}`, 'emergency');

    try {
        const res = await fetch('/api/emergency', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({emergency_id,hospital_id,required_blood_type:blood_type,units_required})
        });
        const data = await res.json();

        if(!data.sources || data.sources.length===0){
            addConsoleLog(`‚ùå No ${blood_type} blood found`, 'warning');
        } else {
            const lives_saved = data.sources.reduce((acc,s)=>acc+s.units,0);
            addConsoleLog(`‚úÖ ${lives_saved} units secured from ${data.sources.length} source(s)`, 'success');
        }

        loadMapData();

    } catch(err){
        addConsoleLog(`Error: ${err.message}`, 'emergency');
    }
}

// Auto-refresh map and logs every 3 seconds
setInterval(loadMapData,3000);
</script>
</body>
</html>