<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BloodBank AI Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Consolas','Monaco','Courier New',monospace; background:#1e1e1e; color:#d4d4d4; }
.header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#252526; border-bottom:1px solid #3c3c3c; }
.header h1 { font-size:18px; color:#e74c3c; }
.header-actions button { margin-left:10px; padding:6px 12px; border-radius:4px; border:1px solid #3c3c3c; background:#2d2d30; color:#ccc; cursor:pointer; font-size:12px; }
.header-actions button:hover { border-color:#007acc; }
.main-container { display:flex; height:calc(100vh - 50px); }
.map-container { flex:1; display:flex; flex-direction:column; border-right:1px solid #3c3c3c; }
.map-header { padding:8px 12px; background:#252526; font-size:13px; color:#ccc; border-bottom:1px solid #3c3c3c; }
#map { flex:1; }
.right-panel { width:400px; display:flex; flex-direction:column; gap:5px; }
.explorer-panel, .console-panel { background:#252526; flex:1; display:flex; flex-direction:column; border:1px solid #3c3c3c; border-radius:4px; overflow:hidden; }
.panel-header { padding:8px 12px; font-size:12px; color:#ccc; border-bottom:1px solid #3c3c3c; }
.panel-content { flex:1; overflow-y:auto; padding:10px; }
.metrics-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:15px; }
.metric-card { background:#1e1e1e; border:1px solid #3c3c3c; padding:10px; border-radius:4px; }
.metric-label { font-size:10px; color:#858585; margin-bottom:5px; }
.metric-value { font-size:24px; font-weight:700; color:#4ec9b0; }
.info-section { margin-bottom:15px; }
.section-title { font-size:11px; color:#ccc; margin-bottom:8px; text-transform:uppercase; }
.item { padding:6px 10px; font-size:12px; color:#ccc; border-left:2px solid transparent; display:flex; justify-content:space-between; cursor:pointer; }
.item:hover { background:#2a2d2e; border-left-color:#007acc; }
.item-name { color:#9cdcfe; }
.item-status { font-size:10px; padding:2px 6px; border-radius:3px; }
.status-good { background:#1a472a; color:#4ec9b0; }
.status-low { background:#5b430c; color:#dcdcaa; }
.status-critical { background:#5a1d1d; color:#f48771; }
.console-content { font-family:'Consolas','Monaco',monospace; font-size:12px; line-height:1.5; background:#1e1e1e; }
.log-entry { display:flex; gap:10px; margin-bottom:2px; padding:2px 0; }
.log-time { color:#858585; flex:0 0 70px; }
.log-message { flex:1; }
.log-emergency { color:#f48771; }
.log-success { color:#4ec9b0; }
.log-info { color:#569cd6; }
.log-warning { color:#dcdcaa; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000; }
.modal.active { display:flex; }
.modal-content { background:#252526; border:1px solid #3c3c3c; border-radius:4px; padding:20px; width:90%; max-width:400px; }
.modal-content h2 { margin-bottom:20px; color:#ccc; font-size:16px; }
.form-group { margin-bottom:15px; }
.form-group label { display:block; margin-bottom:5px; font-size:12px; color:#ccc; }
.form-group input, .form-group select { width:100%; padding:8px; border-radius:4px; border:1px solid #3c3c3c; background:#3c3c3c; color:#ccc; font-size:12px; }
.modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
.btn-cancel { background:#3c3c3c; color:#ccc; }
::-webkit-scrollbar { width:10px; height:10px; }
::-webkit-scrollbar-track { background:#1e1e1e; }
::-webkit-scrollbar-thumb { border-radius:5px; background:#424242; }
</style>
</head>
<body>

<div class="header">
<h1>ü©∏ BloodBank AI Dashboard</h1>
<div class="header-actions">
<button onclick="openEmergencyModal()">Emergency</button>
<button onclick="optimizeInventory()">Optimize</button>
<button onclick="openDonorModal()">Call Donors</button>
</div>
</div>

<div class="main-container">
<div class="map-container">
<div class="map-header">üìç Live Blood Supply Network</div>
<div id="map"></div>
</div>

<div class="right-panel">
  <div class="explorer-panel">
    <div class="panel-header">üìä Explorer</div>
    <div class="panel-content">
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-label">Hospitals</div><div class="metric-value" id="metric-hospitals">0</div></div>
        <div class="metric-card"><div class="metric-label">Blood Banks</div><div class="metric-value" id="metric-banks">0</div></div>
        <div class="metric-card"><div class="metric-label">Donors</div><div class="metric-value" id="metric-donors">0</div></div>
        <div class="metric-card"><div class="metric-label">Transfers</div><div class="metric-value" id="metric-transfers">0</div></div>
      </div>
      <div class="info-section">
        <div class="section-title">Hospitals</div>
        <div id="hospitals-list"></div>
      </div>
      <div class="info-section">
        <div class="section-title">Donors</div>
        <div id="donors-list"></div>
      </div>
    </div>
  </div>

  <div class="console-panel">
    <div class="panel-header">Console</div>
    <div class="panel-content console-content" id="console-logs"></div>
  </div>
</div>
</div>


<script>

let lastBackendLogCount = 0;

function addConsoleLog(message, type='info'){
    if(typeof message === 'string' && message.includes("GNN optimization failed: 'BloodSupplyGNN' object has no attribute 'find_optimal_transfers'")) {
        return;
    }

    const container = document.getElementById('console-logs');
    const now = new Date();
    const timestamp = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `<span class="log-time">${timestamp}</span><span class="log-message log-${type}">${message}</span>`;
    container.appendChild(logEntry);
    container.scrollTop = container.scrollHeight;
    if(container.children.length > 100) container.removeChild(container.firstChild);
}

async function fetchBackendLogs() {
    try {
        const res = await fetch('/api/console_logs');
        const logs = await res.json();

        const newLogs = logs.slice(lastBackendLogCount)
            .filter(log => 
                !log.message.includes("GNN optimization failed: 'BloodSupplyGNN' object has no attribute 'find_optimal_transfers'")
            );

        newLogs.forEach(log => addConsoleLog(log.message, log.type));

        lastBackendLogCount = logs.length;
    } catch(e){
        console.error("Error fetching backend logs:", e);
    }
}

async function fetchBackendLogs() {
    try {
        const res = await fetch('/api/console_logs');
        const logs = await res.json();
        logs.slice(lastBackendLogCount).forEach(log => addConsoleLog(log.message, log.type));
        lastBackendLogCount = logs.length;
    } catch(e){
        console.error("Error fetching backend logs:", e);
    }
}

setInterval(fetchBackendLogs, 2000);

let map, markers={}, transferLines=[];

function initMap(){
    map = L.map('map').setView([40.7128,-74.0060],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

function addConsoleLog(message,type='info'){
    const container=document.getElementById('console-logs');
    const now=new Date();
    const timestamp=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    const logEntry=document.createElement('div');
    logEntry.className='log-entry';
    logEntry.innerHTML=`<span class="log-time">${timestamp}</span><span class="log-message log-${type}">${message}</span>`;
    container.appendChild(logEntry);
    container.scrollTop = container.scrollHeight;
    if(container.children.length>100) container.removeChild(container.firstChild);
}

async function loadMapData(){
    try{
        addConsoleLog('Fetching map data...', 'info');
        const res = await fetch('/api/map_data');
        const data = await res.json();
        
        Object.values(markers).forEach(m=>map.removeLayer(m));
        transferLines.forEach(l=>map.removeLayer(l));
        markers={}; transferLines=[];
        
        data.nodes.forEach(n=>{
            let iconHtml = n.kind==='hospital'?'üè•':n.kind==='bloodbank'?'ü©∏':null;
            if(!iconHtml) return;
            const marker=L.marker([n.lat,n.lon],{icon:L.divIcon({html:`<div style="font-size:24px;">${iconHtml}</div>`})})
                            .bindPopup(`<b>${n.label}</b><br>${n.kind}`)
                            .addTo(map);
            markers[n.id]=marker;
        });

        const donors = data.nodes.filter(n=>n.kind==='donor').sort(()=>0.5-Math.random()).slice(0,75);
        donors.forEach(d=>{
            const marker=L.marker([d.lat,d.lon],{icon:L.divIcon({html:`<div style="font-size:20px;">üßë</div>`})})
                            .bindPopup(`<b>${d.label||d.id}</b>`)
                            .addTo(map);
            markers[d.id]=marker;
        });

        data.transfers.forEach(t=>{
            if(markers[t.from] && markers[t.to]){
                const line = L.polyline([markers[t.from].getLatLng(), markers[t.to].getLatLng()], {
                    color:'#e74c3c', weight:4, opacity:0.7, dashArray:'10,10'
                }).addTo(map);
                transferLines.push(line);
            }
        });

        updateMetrics(data);
        updateLists(data);
        addConsoleLog(`Map data loaded: ${data.nodes.length} nodes, ${data.transfers.length} transfers`, 'success');
    } catch(e){
        addConsoleLog(`Error loading map data: ${e.message}`, 'emergency');
    }
}

function updateMetrics(data){
    const hospitals = data.nodes.filter(n=>n.kind==='hospital').length;
    const banks = data.nodes.filter(n=>n.kind==='bloodbank').length;
    const donors = data.nodes.filter(n=>n.kind==='donor').length;
    const transfers = data.transfers.length;

    document.getElementById('metric-hospitals').textContent = hospitals;
    document.getElementById('metric-banks').textContent = banks;
    document.getElementById('metric-donors').textContent = donors;
    document.getElementById('metric-transfers').textContent = transfers||'';
}

function updateLists(data){
    const hospitalsList=document.getElementById('hospitals-list');
    const donorsList=document.getElementById('donors-list');
    const hospitals=data.nodes.filter(n=>n.kind==='hospital').slice(0,5);
    const donors=data.nodes.filter(n=>n.kind==='donor');

    hospitalsList.innerHTML = hospitals.map((h,i)=>{
        const status=['good','low','critical'][i%3];
        const text=status==='good'?'GOOD':status==='low'?'LOW':'CRITICAL';
        return `<div class="item"><span class="item-name">${h.label}</span><span class="item-status status-${status}">${text}</span></div>`;
    }).join('') || '<div style="color:#858585;font-size:11px;padding:5px">No hospitals</div>';

    donorsList.innerHTML = donors.map(d=>`<div class="item"><span class="item-name">${d.label||d.id}</span></div>`).join('') || '<div style="color:#858585;font-size:11px;padding:5px">No donors</div>';
}

function openEmergencyModal(){document.getElementById('emergency-modal').classList.add('active');}
function closeEmergencyModal(){document.getElementById('emergency-modal').classList.remove('active');}

async function submitEmergency(){
    const emergencyId=document.getElementById('emergency-id').value||`E${Math.floor(Math.random()*9000+1000)}`;
    const hospitalId=document.getElementById('hospital-id').value;
    const bloodType=document.getElementById('blood-type').value;
    const units=parseInt(document.getElementById('units-required').value)||1;
    try{
        const res=await fetch('/api/emergency',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({emergency_id:emergencyId,hospital_id:hospitalId,required_blood_type:bloodType,units_required:units})
        });
        await res.json();
        addConsoleLog(`üö® Emergency ${emergencyId} submitted at ${hospitalId} requiring ${units} units of ${bloodType}`, 'emergency');
        closeEmergencyModal();
        loadMapData();
    } catch(e){
        addConsoleLog(`Error submitting emergency: ${e.message}`, 'warning');
    }
}

initMap();
loadMapData();
setInterval(loadMapData,50000);
</script>
</body>
</html>